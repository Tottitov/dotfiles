#!/bin/sh

check() {
	(iwctl --passphrase "$1" station "wlan0" connect "$2" &&
		notify-send "Password succeeded for $2") ||
		notify-send -u critical "Password failed for $2"
} >/dev/null 2>&1

forget() {
	(iwctl known-networks "$1" forget &&
		notify-send "$1" "Forgotten") ||
		notify-send -u critical "$1" "Failed to forget"
} >/dev/null 2>&1

connect() {
	security=$(iwctl station "wlan0" get-networks | ansifilter | rg "${1}\s" | awk '{ print $(NF-1) }')
	if ! iwctl known-networks list | rg -qF "$1" && [ -n "$security" ] && [ "$security" != "open" ]; then
		password=$(fuzzel -w 50 --password -di --prompt-only="password: ") && check "$password" "$1"
	else
		(iwctl station "wlan0" connect "$1" &&
			notify-send "$1" "Connected") ||
			notify-send -u critical "$1" "Failed to connect"
	fi
} >/dev/null 2>&1

iwctl device list | rg -q "off" && {
	notify-send -u critical "WiFi is not enabled"
	exit 1
}

networks=$(iwctl station "wlan0" get-networks | ansifilter | cut -c7- | tail -n +5 | cut -c1-32 | sed 's/ *$//')
[ "$networks" = "No networks available" ] && {
	notify-send -u critical "No WiFi networks found"
	exit 1
}

connected=$(iwctl station "wlan0" show | rg "Connected network" | sed 's/.*Connected network *//' | xargs)
choice=$(echo "$networks" | fuzzel --only-match --placeholder="$connected" -w 30 -di) || exit 1
is_known=$(iwctl known-networks list | rg -qF "$choice" && echo "yes" || echo "no")

if [ "$choice" = "$connected" ]; then
	action=$(printf "Disconnect\nForget" | fuzzel --only-match -w 20 -di) || exit 1
	case "$action" in
	Disconnect) iwctl station "wlan0" disconnect && notify-send "$choice" "Disconnected" ;;
	Forget) forget "$choice" ;;
	esac
elif [ "$is_known" = "yes" ]; then
	action=$(printf "Connect\nForget" | fuzzel --only-match -w 20 -di) || exit 1
	case "$action" in
	Connect) connect "$choice" ;;
	Forget) forget "$choice" ;;
	esac
else
	connect "$choice"
fi
